var tinyMapEditor=function(){var a=window,b=document,c=b.getElementById("palette").getContext("2d"),d=b.getElementById("tileEditor").getContext("2d"),e=10,f=32,g=0,h=new Image,i,j,k,l,m=b.getElementById("build"),n=b.getElementById("test"),o={getTile:function(a){if(a.target.nodeName==="CANVAS"){var b=a.layerX/f|0,c=a.layerY/f|0;a.target.id==="palette"&&(g={row:b,col:c});return{row:b,col:c}}},setTile:function(a){var b;a.target.id==="tileEditor"&&g&&!l&&(b=o.getTile(a),d.clearRect(b.row*f,b.col*f,f,f),d.drawImage(h,g.row*f,g.col*f,f,f,b.row*f,b.col*f,f,f))},drawTool:function(){var a=b.createElement("canvas"),c=a.getContext("2d"),d=function(){c.fillStyle="red",c.fillRect(0,0,f,f),c.fillStyle="white",c.fillRect(2,2,f-4,f-4),c.strokeStyle="red",c.lineWidth=2,c.moveTo(f,0),c.lineTo(0,f),c.stroke()};a.width=a.height=f,b.getElementById("selected").appendChild(a),d(),o.drawTool=function(){a.width=f,g?c.drawImage(h,g.row*f,g.col*f,f,f,0,0,f,f):d()}},eraseTile:function(a){var b;l||(a.target.id==="erase"&&g?g=0:a.target.id==="tileEditor"&&!g&&(b=o.getTile(a),d.clearRect(b.row*f,b.col*f,f,f)))},clearMap:function(a){a.target.id==="clear"&&(d.clearRect(0,0,d.canvas.width,d.canvas.height),p.destroy(),n.disabled=!0,m.disabled=!1)},buildMap:function(a){if(a.target.id==="build"){var b={},c,g,h,k,l;i=[],j=[];for(h=0;h<e;h++){i[h]=[],j[h]=[];for(k=0;k<e;k++){c=d.getImageData(k*f,h*f,f,f),g=c.data.length,i[h][k]=c,j[h][k]=[];for(l=0;l<g;l+=4)c.data[l]=0,c.data[l+1]=0,c.data[l+2]=0,j[h][k][l/4]=c.data[l+3];j[h][k].indexOf(0)===-1?j[h][k]=1:j[h][k].indexOf(255)===-1?j[h][k]=0:(j[h][k]=o.sortPartial(j[h][k]),i[h][k]=c)}}o.outputJSON(),p.drawMap(),n.disabled=!1}},sortPartial:function(a){var b=a.length,c=[],d,e;for(d=0;d<f;d++){c[d]=[];for(e=0;e<b;e++)e%f===e&&(c[d][e]=a[e*f+d]);c[d]=c[d].indexOf(255)}return c},outputJSON:function(){var a={layerName:"collision",tileSize:f,imgSrc:h.src,mapData:j};a="var collisionMap = "+JSON.stringify(a),b.getElementsByTagName("textarea")[0].value=a},bindEvents:function(){a.addEventListener("click",function(a){o.setTile(a),o.getTile(a),o.eraseTile(a),o.drawTool(),o.clearMap(a),o.buildMap(a),p.testMap(a)},!1),h.addEventListener("load",function(){d.canvas.width=d.canvas.height=e*f,c.canvas.width=this.width,c.canvas.height=this.height,c.drawImage(this,0,0)},!1)},init:function(){h.src="assets/tilemap_32a.png",o.bindEvents(),o.drawTool()}},p={createChar:function(){this.height=16,this.width=8,this.x=e*f/2-this.width/2,this.y=0,this.dx=1,this.dy=1,this.vel=5,this.grav=10;return this},drawChar:function(){d.fillStyle="purple",d.fillRect(k.x,k.y,k.width,k.height),k.x+=k.dx*k.vel,k.y+=k.dy*k.grav},checkCollision:function(){var a=k.y/f|0,b=k.x/f|0,c=p.keys;a<e?a===e-1&&typeof j[a][b]!="object"?!j[a][b]&&!j[a][b+1]?k.y=e*f-k.height:(k.vel=0,k.y=e*f-k.height):typeof j[a][b]=="object"?k.y=(a+1)*f-k.height-(f-j[a][b][k.x%f]+1):typeof j[a+1][b]=="object"?k.y=(a+2)*f-k.height-(f-j[a+1][b][k.x%f]+1):j[a+1][b]===1?k.y=(a+1)*f-k.height:j[a+1][b]===0&&j[a+1][b+1]===1&&k.x>(b+1)*f-k.width&&(k.y=(a+1)*f-k.height):k.y=e*f-k.height,c.left&&k.x>0?(k.dx=-1,j[a][b]===1?k.vel=0:k.vel=3):c.right&&k.x<e*f-k.width?(k.dx=1,j[a][b+1]===1?k.x>=(b+1)*f-k.width?k.vel=0:k.vel=3:k.vel=3):k.vel=0},drawMap:function(){var a,b;d.fillStyle="black";for(a=0;a<e;a++)for(b=0;b<e;b++)j[a][b]===1?d.fillRect(b*f,a*f,f,f):typeof j[a][b]=="object"&&d.putImageData(i[a][b],b*f,a*f)},testMap:function(a){a.target.id==="test"&&!l&&(p.init(),n.disabled=!0,m.disabled=!0)},keys:{left:!1,right:!1,up:!1},bindEvents:function(){var b=p.keys;a.addEventListener("keydown",function(a){switch(a.keyCode){case 37:b.left=!0;break;case 38:b.up=!0,a.preventDefault();break;case 39:b.right=!0}},!1),a.addEventListener("keyup",function(a){switch(a.keyCode){case 37:b.left=!1;break;case 38:b.up=!1;break;case 39:b.right=!1}},!1)},init:function(){k=new p.createChar,l=setInterval(function(){p.update()},25)},update:function(){d.clearRect(0,0,d.canvas.width,d.canvas.height),p.drawMap(),p.checkCollision(),p.drawChar()},destroy:function(){clearInterval(l),k=l=null,j=[]}};o.init(),p.bindEvents();return o}()